<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr" xmlns:th="http://www.thymeleaf.org">
<head>
<th:block th:include="fragments/head"></th:block>

</head>
<body>
    <!-- fixed-top-->
    <th:block th:include="fragments/nav"></th:block>
    <!-- ////////////////////////////////////////////////////////////////////////////-->
    <!-- Horizontal navigation-->
    <th:block th:include="fragments/hnav"></th:block>
    <!-- Horizontal navigation-->

    <!-- form body -->
    <th:block th:include="fragments/order/new"></th:block>

    <!-- Dialog to select Customer -->
    <th:block th:include="fragments/customer/select"></th:block>

    <!-- Google Map Modal -->
    <th:block th:include="fragments/order/map"></th:block>

    <!-- footer -->
    <th:block th:include="fragments/footer"></th:block>
    <script>
        var dataProducts = [["", "" , "", "", "", "", ""]
        ];

        var hotProduct = null;

        $(function() {
        	var containerProduct = document.getElementById('tableProduct');

        	hotProduct = new Handsontable(containerProduct, {
                data: dataProducts,
                colHeaders: ["ID", "Tên mặt hàng", "Dài(m)", "Rộng(m)", "Cao(m)", "Trọng lượng (kg)", "Số lượng"],
                colWidths: [50, 300, 100, 100, 100, 120, 100],
                rowHeaders: true,
                minRows: 5,
//                 minCols: 5,
//                 currentRowClassName: 'currentRow',
//                 currentColClassName: 'currentCol',
            	manualColumnResize: true,
                manualRowResize: true
//                 , columns: [
//                     {data: 'name'},
//                     {data: 'length'},
//                     {data: 'width'},
//                     {data: 'height'},
//                     {data: 'weight'}
//                   ]
              });

     
        });

        // Load lại danh sách sản phẩm của đơn hàng
        function loadProducts(orderCd) {
            // load demo data.

            $.ajax({
                url : _ctx + 'load-product?orderCd=' + orderCd,
                type : 'GET',
                dataType : 'json',
                contentType : 'application/json',
                success : function(res) {
                    console.log("res=" + res);
                    dataProducts = JSON.parse(res);
                    hotProduct.loadData(dataProducts);
                },
                error : function (e) {
                    console.log("Error: " + e);
                }
            });
        }
    </script>

    <!-- Save the order -->
    <script>
        $('#frmOrder').submit(function(e) {
            e.preventDefault();
    
            var frm = $('#frmOrder');
            var orderCd = $('#orderCd').val();
            var address = $('#address').val();
            var latitude = $('#latitude').val();
            var longitude = $('#longitude').val();
            var customer_name = $('#customer_name').val();
            console.log(customer_name);
    
            // Get header name
            var colHeaderData =  hotProduct.getColHeader();
            
            // Get data from Handsontable
            var tableData = hotProduct.getData();

            var frmData = {};
            frmData["productHeader"] = colHeaderData;
            frmData["productData"] = tableData;
            frmData["orderCd"] = orderCd;
            frmData["address"] = address;
            frmData["latitude"] = latitude;
            frmData["longitude"] = longitude;
            frmData["customer_name"] = customer_name;
            console.log(frmData);

            $.ajax({
                url : _ctx + "/order/save",
                type : "POST",
                contentType: "application/json",
                data: JSON.stringify(frmData),
                dataType: 'json',

                success : function(result) {
                    // reload data
                	loadProducts(orderCd);
                },
                error : function() {
                    console.log("Error!");
                }
            });
        });
    </script>
    <!--  Scripts for select customer -->
    <script>
        // Dispay dialog of addresses
        var selectCustomerTable = null;
    
        $('#btnSelectCustomer').click(function(e) {
            // Load dữ liệu khách hàng
        	if (selectCustomerTable == null) {
        		selectCustomerTable = $("#selectCustomerTable").DataTable({
                    ajax: {'url': _ctx + 'customer/load-customer', 'dataSrc': ''},
                    "columns": [
                           {"render": function ( data, type, full, meta ) {
                                // return '<input type="radio" name="addressRow" value="' + full.displayAddress + '">';
                               // Assign address id and displayAddress
                        	   return '<input type="radio" name="addressRow" value="' + full.id + '">';
                           }},  // here's a radio button, modify to use data to populate it
                    	   { "data": "id" },
                    	   { "data": "name" },
                    	   { "data": "addr" }
                    ]
                });
        	} else {
        		// selectAddressTable.fnDraw();
            }

            // Hiển thị hộp thoại
        	$("#dlgSearchCustomer").modal('show');
        });

        $('#btnSelectedCustomer').click(function(e) {

            var selectedCustomerId = $('input[name=addressRow]:checked').val();

            // Get Fulll addres from Id
            $.ajax({
                url : _ctx + "customer/load-customer/" + selectedCustomerId,

                success : function(result) {
                    console.log("Load customer result =" + JSON.stringify(result));
                    
                    // fresh address
                    refreshCustomer(result);
                },
                error : function() {
                    console.log("Error!");
                }
            });
        });

        /**
         * @param addrId
         * @param fullAddr
         * @global selectCustomerRow
         */
        function refreshCustomer(customer) {
            // Set address into Address of the Customer
            $('#customer_name').val(customer.name);
            $('#customer_phone').val(customer.phone);
            $('#customer_addr').val(customer.addr);

        }
    </script>


    <script async defer th:src="@{https://maps.googleapis.com/maps/api/js?key=} + ${map_key}">
    </script>

    <script> 
        $('#btnShowMap').click(function(e) {
            initMap();
        });
        function initMap(){
            var geocoder = new google.maps.Geocoder();
            var address =  $('#customer_addr').val();
        
            geocoder.geocode({'address': address}, function(results, status) {
                  if (status === 'OK') {
                     console.log(results);
//     	             var map = new google.maps.Map($('#map_canvas'), {
//                    zoom: 15,
//                    center: results[0].geometry.location
//                 });
                     var myOptions = {
    	                       zoom: 15,
                               center: results[0].geometry.location,
                               mapTypeId: google.maps.MapTypeId.ROADMAP
                         };
                 
                     var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
                     var marker = new google.maps.Marker({
                               map: map,
                               position: results[0].geometry.location
                         });
                     $('#latitude').val(results[0].geometry.location.lat);
                     $('#longitude').val(results[0].geometry.location.lng);
                     $("#googleMapModal").modal('show');
                  } else {
                      alert('Geocode was not successful for the following reason: ' + status);
                  }
 	        });
        }
  </script>

</body>
</html>